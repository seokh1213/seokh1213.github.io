---
interface Props {
  headings: {
    depth: number;
    slug: string;
    text: string;
  }[];
}

const {headings} = Astro.props;

// depth에 따른 padding 설정
const getIndentClass = (depth: number) => {
  const base = "hover:text-neutral-900 dark:hover:text-neutral-100";
  switch (depth) {
    case 2:
      return `${base} pl-2`;
    case 3:
      return `${base} pl-4`;
    case 4:
      return `${base} pl-6`;
    default:
      return base;
  }
};
---

<nav class="">
  <p
    class="mb-3 font-bold text-sm flex items-center text-[var(--secondary-text-color)] dark:text-[var(--secondary-text-color-dark)]">
    목차
  </p>
  <ul class="space-y-2.5 text-sm">
    {
      headings.map((heading) => (
        <li>
          <a
            href={`#${heading.slug}`}
            class={`block text-neutral-500 dark:text-neutral-400 transition-colors ${getIndentClass(heading.depth)}`}
          >
            {heading.text}
          </a>
        </li>
      ))
    }
  </ul>
</nav>

<script>
  let currentActiveLink: Element | null = null;

  // 모든 heading 요소들을 저장
  const headingElements = Array.from(document.querySelectorAll('article h2, article h3, article h4'));
  const tocLinks = document.querySelectorAll('[data-heading-link]');

  // 현재 활성화된 링크의 스타일을 제거하는 함수
  const removeActiveStyles = () => {
    if (currentActiveLink) {
      currentActiveLink.classList.remove('text-[#F97316]', 'dark:text-[#E34D0A]', 'font-medium');
    }
  };

  // 새로운 링크를 활성화하는 함수
  const setActiveLink = (link: Element) => {
    removeActiveStyles();
    link.classList.add('text-[#F97316]', 'dark:text-[#E34D0A]', 'font-medium');
    currentActiveLink = link;
  };

  // 스크롤 위치에 따라 현재 섹션을 찾는 함수
  const updateActiveSection = () => {
    const pageTop = window.scrollY;
    const pageMiddle = pageTop + (window.innerHeight / 2);

    // 현재 화면에 보이는 모든 헤딩을 찾습니다
    let currentSection = null;

    for (const heading of headingElements) {
      const rect = heading.getBoundingClientRect();
      const elemTop = rect.top + pageTop;

      // 화면 중앙보다 위에 있는 마지막 헤딩을 현재 섹션으로 설정
      if (elemTop <= pageMiddle) {
        currentSection = heading;
      } else {
        break;
      }
    }

    // 현재 섹션이 없고 페이지 맨 위라면 첫 번째 헤딩을 선택
    if (!currentSection && pageTop < 100 && headingElements.length > 0) {
      currentSection = headingElements[0];
    }

    if (currentSection) {
      const id = currentSection.getAttribute('id');
      const correspondingLink = document.querySelector(`a[href="#${id}"]`);
      if (correspondingLink && correspondingLink !== currentActiveLink) {
        setActiveLink(correspondingLink);
      }
    }
  };

  // 스크롤 이벤트에 throttle 적용
  let ticking = false;
  document.addEventListener('scroll', () => {
    if (!ticking) {
      window.requestAnimationFrame(() => {
        updateActiveSection();
        ticking = false;
      });
      ticking = true;
    }
  });

  // 초기 로드 시 현재 섹션 설정
  updateActiveSection();

  // 클릭 시 스무스 스크롤 처리
  tocLinks.forEach(link => {
    link.addEventListener('click', (e) => {
      e.preventDefault();
      const href = link.getAttribute('href');
      if (href) {
        const targetElement = document.querySelector(href);
        if (targetElement) {
          targetElement.scrollIntoView({behavior: 'smooth'});
          setActiveLink(link);
        }
      }
    });
  });
</script>